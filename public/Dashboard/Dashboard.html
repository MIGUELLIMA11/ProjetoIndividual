<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Gurren Lagann Quiz</title>
    <link rel="stylesheet" href="/Dashboard/dash.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="user-profile">
                <i class="fas fa-user-circle fa-3x"></i>
                <span id="b_usuario">Usuário</span>
            </div>
            <nav class="menu">
                <a href="#">Dashboard</a>
                <a href="#">Configurações</a>
                <a href="../PaginaHome/PaginaHome.html">Sair</a>
            </nav>
        </aside>
        <div class="main"> 
        <div class="main-content">
            <header class="header">
                <h1>Gurren Lagann Quiz Dashboard</h1>
            </header>
            <section class="kpis">
                <div class="kpi-card">
                    <h3>Tentativas</h3>
                    <p id="kpiTentativas">--</p>
                </div>
                <div class="kpi-card">
                    <h3>Media de acertos</h3>
                    <p id="kpiAcertos">--</p>
                </div>
                <div class="kpi-card">
                    <h3>Media de erros</h3>
                    <p id="kpiErros">--</p>
                </div>
                 <div class="kpi-card">
                    <h3>Perguntas</h3>
                    <p id="kpiRPerguntas">--</p>
                </div>
            </section>
            <section class="graficos">
                <h2 class="tituloGraficos">Desempenho</h2>
                <div id="graficos" class="graph"></div>
            </section>
        </div>
    </div>
</div>
</body>
</html>
<script>
 var idUsuario = sessionStorage.getItem('ID_USUARIO');
 console.log("ID_USUARIO:", sessionStorage.getItem("ID_USUARIO"));

   function exibirGrafico(idUsuario) {
        
    obterDadosGrafico(idUsuario)
    let todosOsGraficos = JSON.parse(sessionStorage.GRAFICOS_USUARIO)

        for (i = 0; i < todosOsGraficos.length; i++) {
            // exibindo - ou não - o gráfico
            if (todosOsGraficos[i].id != idUsuario) {
                let elementoAtual = document.getElementById(`grafico${todosOsGraficos[i].id}`)
                if (elementoAtual.classList.contains("display-block")) {
                    elementoAtual.classList.remove("display-block")
                }
                elementoAtual.classList.add("display-none")

                // alterando estilo do botão
                let btnAtual = document.getElementById(`btnAquario${todosOsGraficos[i].id}`)
                if (btnAtual.classList.contains("btn-pink")) {
                    btnAtual.classList.remove("btn-pink")
                }
                btnAtual.classList.add("btn-white")
            }
        }

        // exibindo - ou não - o gráfico
        let graficoExibir = document.getElementById(`grafico${idUsuario}`)
        graficoExibir.classList.remove("display-none")
        graficoExibir.classList.add("display-block")

        // alterando estilo do botão
        let btnExibir = document.getElementById(`btnAquario${idUsuario}`)
        btnExibir.classList.remove("btn-white")
        btnExibir.classList.add("btn-pink")
    }


 let proximaAtualizacao;
    if (idUsuario) {
        // Exibir o nome do usuário na interface
        b_usuario.innerHTML = sessionStorage.getItem('NOME_USUARIO');

        // Chama a função para obter dados de gráfico, passando o idUsuario
        obterDadosGrafico(idUsuario);
    } else {
        console.error("Usuário não autenticado ou ID do usuário não encontrado.");
    }
    // O gráfico é construído com três funções:
    // 1. obterDadosGrafico -> Traz dados do Banco de Dados para montar o gráfico da primeira vez
    // 2. plotarGrafico -> Monta o gráfico com os dados trazidos e exibe em tela
    // 3. atualizarGrafico -> Atualiza o gráfico, trazendo novamente dados do Banco
    // Esta função *obterDadosGrafico* busca os últimos dados inseridos em tabela de medidas.
    // para, quando carregar o gráfico da primeira vez, já trazer com vários dados.
    // A função *obterDadosGrafico* também invoca a função *plotarGrafico*
    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models
function obterDadosGrafico(idUsuario) {
    fetch(`/medidas/ultimas/${idUsuario}`)  // Chama a API com o ID do usuário
        .then(response => response.json())  // Converte a resposta para JSON
        .then(tentativas => {
            // Suponha que tentativas seja um array com as últimas tentativas
            if (tentativas.length > 0) {
                // Armazena os dados das tentativas no sessionStorage
                sessionStorage.setItem("TENTATIVAS_USUARIO", JSON.stringify(tentativas));

                // Agora, você pode chamar a função que gera o gráfico com esses dados
                plotarGrafico(tentativas);  // Exemplo de função que gera o gráfico
            } else {
                console.error("Nenhuma tentativa encontrada.");
            }
        })
        .catch(error => console.error("Erro ao obter dados de gráfico: ", error));
}
    // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
    // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
    // A função *plotarGrafico* também invoca a função *atualizarGrafico*
  function plotarGrafico(resposta, idUsuario) {
    console.log('iniciando plotagem do gráfico...');

    let labels = [];
    let dadosAcertos = [];
    let dadosErros = [];
    let tempos = [];

    for (let i = 0; i < resposta.length; i++) {
        let registro = resposta[i];
        labels.push(registro.idTentativa);          // Label eixo X = idTentativa
        dadosAcertos.push(registro.Acertos);
        dadosErros.push(registro.Erros);
        tempos.push(registro.tempo_minutos_segundos); // Guarda o tempo para tooltip
    }

    let dados = {
        labels: labels,
        datasets: [
            {
                label: 'Acertos',
                data: dadosAcertos,
                backgroundColor: 'rgba(0, 255, 0, 0.6)', 
                borderColor: 'rgb(0, 255, 0)',
                tension: 0.1,
                // Vamos adicionar tooltip customizado abaixo
            },
            {
                label: 'Erros',
                data: dadosErros,
                backgroundColor: 'rgba(255, 0, 0, 0.6)',
                borderColor: 'rgb(255, 0, 0)',
                tension: 0.1,
            }
        ]
    };

    // Cria canvas se não existir
    let divGraficos = document.getElementById('graficos');
    let graficoExistente = document.getElementById(`myChartCanvas${idUsuario}`);
    if (!graficoExistente) {
        let canvas = document.createElement('canvas');
        canvas.id = `myChartCanvas${idUsuario}`;
        divGraficos.appendChild(canvas);
    }

    const config = {
        type: 'bar',
        data: dados,
        options: {
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            let idx = context.dataIndex;
                            let tempo = tempos[idx] || '';
                            return `${label}: ${context.parsed.y} (${tempo})`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'ID da Tentativa'
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Quantidade'
                    }
                }
            }
        }
    };

    let myChart = new Chart(
        document.getElementById(`myChartCanvas${idUsuario}`),
        config
    );

    setTimeout(() => atualizarGrafico(idUsuario, dados, myChart), 2000);
}
    // Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
    // buscando a última medida inserida em tabela contendo as capturas, 

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models
   /* function atualizarGrafico(idUsuario, dados, myChart) {

        fetch(`/medidas/tempo-real/${idUsuario}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {

                    obterdados(idUsuario);
                    // alertar(novoRegistro, idAquario);
                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico:`);
                    console.log(dados);

                    let avisoCaptura = document.getElementById(`avisoCaptura${idUsuario}`)
                    avisoCaptura.innerHTML = ""


                    if (novoRegistro[0].momento_grafico == dados.labels[dados.labels.length - 1]) {
                        console.log("---------------------------------------------------------------")
                        console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                        avisoCaptura.innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
                        console.log("Horário do novo dado capturado:")
                        console.log(novoRegistro[0].momento_grafico)
                        console.log("Horário do último dado capturado:")
                        console.log(dados.labels[dados.labels.length - 1])
                        console.log("---------------------------------------------------------------")
                    } else {
                        // tirando e colocando valores no gráfico
                        dados.labels.shift(); // apagar o primeiro
                        dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento

                        dados.datasets[0].data.shift();  // apagar o primeiro de umidade
                        dados.datasets[0].data.push(novoRegistro[0].umidade); // incluir uma nova medida de umidade

                        dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
                        dados.datasets[1].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura

                        myChart.update();
                    }

                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(idUsuario, dados, myChart), 2000);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                proximaAtualizacao = setTimeout(() => atualizarGrafico(idUsuario, dados, myChart), 2000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            }); 

    } */ 
</script>